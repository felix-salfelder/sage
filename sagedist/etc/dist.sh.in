# this file is part of Sage
# (c) 2013 Felix Salfelder
# license: gplv3+
#

# these are the environment bits required to build packages and to run sage on
# sage ("the distribution").

# FIXME: relocation, must probably be triggered here

# must be exported here, so it gets included into bin/env.sh when
# running inside sage-the-distribution
SAGE_LOCAL=@abs_top_builddir@/local
export SAGE_LOCAL

SAGE_ROOT="@abs_top_builddir@"
export SAGE_ROOT

maybe_colon=
[ -z "$LIBRARY_PATH" ] || maybe_colon=:
LIBRARY_PATH="$LIBRARY_PATH#maybe_colon$SAGE_LOCAL/lib"
export LIBRARY_PATH

# Add some directories to $LD_LIBRARY_PATH:
# * lib/openmpi is needed for openmpi.
# * lib/R/lib is needed for R in case the Sage install is moved.
# * lib32 and lib64 are needed for GCC, see #12405.
for d in lib/openmpi lib/R/lib lib32 lib64 lib; do
    libdir="$SAGE_LOCAL/$d"
    # Add only existing directories
    if [ -d "$libdir" ]; then
        [ -z "$LD_LIBRARY_PATH" ] || LD_LIBRARY_PATH=":${LD_LIBRARY_PATH}"
        LD_LIBRARY_PATH="${libdir}$LD_LIBRARY_PATH"
    fi
done
export LD_LIBRARY_PATH

# stage packages into SAGE_LOCAL for now.
SAGE_PREFIX=$SAGE_LOCAL
export SAGE_PREFIX

# dummywall beween SAGE_LOCAL/bin and system paths
PATH="$SAGE_ROOT/sagedist/bin:$PATH"
PATH="@abs_top_srcdir@/sagedist/bin:$PATH"

PATH="$SAGE_LOCAL/bin:$PATH"

# sage_fortran
PATH="$SAGE_ROOT/build/bin:$PATH"
export PATH

CPPFLAGS+=" -I$SAGE_LOCAL/include"
CPPFLAGS+=" -I$SAGE_LOCAL/include/csage"
export CPPFLAGS

# maxima build will fail if LDFLAGS contains extra whitespace (d'0h)
LDFLAGS+="-L$SAGE_LOCAL/lib"
export LDFLAGS

SAGE_DOC="@abs_top_builddir@/src/doc"
export SAGE_DOC

# this could well be part of sagelib/spkg-install (after cleanup)
SAGE_SRC="@SAGE_SRC@"
export SAGE_SRC

SAGE_DOC_SRC="@abs_top_srcdir@/src/doc"
export SAGE_DOC_SRC

SAGE_DISTFILES="@abs_top_builddir@/upstream"
export SAGE_DISTFILES

# PKG_CONFIG_PATH is used by 'pkg-config' on Solaris and Linux,
# but at least some versions of OS X do not have the pkg-config
# command, so relying on this is not wise on OS X.
if [ -z "$PKG_CONFIG_PATH" ]; then
    PKG_CONFIG_PATH="$SAGE_LOCAL/lib/pkgconfig"
else
    PKG_CONFIG_PATH="$SAGE_LOCAL/lib/pkgconfig:$PKG_CONFIG_PATH"
fi
export PKG_CONFIG_PATH

###### FIXME: decruft ######

# Setup env varariables if ccache is installed
if [ -d "$SAGE_LOCAL/libexec/ccache" ]; then
    PATH="$SAGE_LOCAL/libexec/ccache:$PATH"
fi
if [ -z "$CCACHE_BASEDIR" ]; then
    export CCACHE_BASEDIR="$SAGE_ROOT"
fi

if [ "$LD" = "" ]; then
    LD="ld"  && export LD
fi
if [ "$AR" = "" ]; then
    AR="ar"  && export AR
fi
if [ "$AS" = "" ]; then
    AS="as"  && export AS
fi

if [ "$CXXFLAGS" = "" ]; then
    export CXXFLAGS="$CFLAGS"
fi

if [ "$CP" = "" ]; then
    CP="cp"  && export CP
fi

if [ "$MV" = "" ]; then
    MV="mv"  && export MV
fi

if [ "$RANLIB" = "" ]; then
    RANLIB="ranlib"  && export RANLIB
fi

if [ "$LN" = "" ]; then
    LN="ln"  && export LN
fi

if [ "$MKDIR" = "" ]; then
    MKDIR="mkdir"  && export MKDIR
fi

if [ "$CHMOD" = "" ]; then
    CHMOD="chmod"  && export CHMOD
fi

if [ "$TOUCH" = "" ]; then
    TOUCH="touch"  && export TOUCH
fi

