#!/usr/bin/env sage-dist-make

THIS_MAKEFILE := $(lastword $(MAKEFILE_LIST))

all: install

# ugly, but works when called like old spkg-install
COMMONMK?=spkg.mk
include $(COMMONMK)

###############################################################################
# Set up environment variables:
###############################################################################
# FIXME!!
LD_CBLAS=$(shell cat $(SAGE_LOCAL)/share/cblas_config 2>/dev/null)
LDFLAGS+=-L$(SAGE_LOCAL)/lib $(LD_CBLAS)

CFLAGS+=-g -fPIC
CXXFLAGS+=-g -fPIC

# Some systems have problems when parts of LinBox are compiled with
# the commentator enabled and other parts with the commentator
# disabled.  Therefore, disable it always.
CPPFLAGS+=-DDISABLE_COMMENTATOR

ifeq ($(SAGE64),yes)
    CFLAG64?=-m64
	 CFLAGS+=$(CFLAG64)
	 CXXFLAGS+=$(CFLAG64)
	 CPPFLAGS+=$(CFLAG64)
	 LDFLAGS+=$(CFLAG64)
endif


###############################################################################
# Configure, build and install LinBox:
###############################################################################

configure: patch-stamp
	cd src;\
	./configure --prefix="$(SAGE_LOCAL)" --libdir="$(SAGE_LOCAL)/lib" \
	            --with-default="$(SAGE_LOCAL)" \
	            --enable-sage --enable-optimization --disable-static

build: configure
	$(MAKE) -Csrc

install: build
	$(MAKE) -Csrc install INSTALL="$(SAGE_INSTALL)"


.PHONY: build configure
